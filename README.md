# repo

ä½ é€™å€‹è³‡æ–™å¤¾æ˜¯ **ç”¨ä¾†ç·´ç¿’åœ¨ GCP ä¸Šè‡ªå‹•éƒ¨ç½²ç°¡æ˜“ç¶²é æœå‹™åˆ° Cloud Run çš„å®Œæ•´æµç¨‹**ï¼Œå…§å®¹ä¸»è¦æ¶µè“‹ä»¥ä¸‹é‡é»ï¼š

---

## ğŸ” ä½ é€™å€‹ç·´ç¿’åœ¨åšä»€éº¼ï¼Ÿ

ä½ æ˜¯é€é **Cloud Build CI/CD æµç¨‹**ï¼Œç•¶ GitHub ä¸Š `main` åˆ†æ”¯æœ‰ push æ™‚ï¼Œè‡ªå‹•ï¼š

1. **Build**ï¼šå»ºæ§‹ä¸€å€‹ Docker imageï¼Œå…§å« Apache å’Œ `index.html` ç¶²é ã€‚
2. **Push**ï¼šå°‡é€™å€‹æ˜ åƒæª”æ¨é€åˆ° GCP çš„ **Artifact Registry**ã€‚
3. **Deploy**ï¼šæŠŠé€™å€‹æ˜ åƒæª”éƒ¨ç½²åˆ° **Cloud Run**ï¼Œä¸¦è¨­å®šç‚ºå¯å…¬é–‹è¨ªå•ã€‚

---

## ğŸ“‚ å„æª”æ¡ˆä½œç”¨è§£æ

### `cloudbuild.yaml`

Cloud Build çš„éƒ¨ç½²è…³æœ¬ï¼Œå…± 3 å€‹æ­¥é©Ÿï¼š

1. å»ºæ§‹ Docker æ˜ åƒæª”ï¼ˆv03ï¼‰
2. æ¨é€æ˜ åƒåˆ° Artifact Registry
3. å°‡æ˜ åƒéƒ¨ç½²åˆ° Cloud Runï¼Œæœå‹™åç¨±ç‚º `my-repo`

```yaml
images:
  - 'asia-east1-docker.pkg.dev/lab-dev-421508/my-repo/ap:v03'
```

---

### `Dockerfile`

å®šç¾©å¦‚ä½•ç”¢å‡ºè©²ç¶²é æœå‹™çš„æ˜ åƒæª”ï¼š

* ä½¿ç”¨ Ubuntu 20.04 + Apache2
* è¤‡è£½ `index.html` åˆ° `/var/www/html/index.html`
* åŸ·è¡Œ Apache ä½œç‚ºå‰æ™¯ç¨‹åº

é€™ä»£è¡¨éƒ¨ç½²å¾Œé–‹å•Ÿæœå‹™ç¶²å€ï¼Œå°±æœƒçœ‹åˆ°å…§å®¹é¡ä¼¼ï¼š

```
AP
V03
```

---

### `index.html`

éœæ…‹ç¶²é ï¼Œé¡¯ç¤ºï¼š

```
AP
V03
```

é€™å¯èƒ½æ˜¯ç‚ºäº†æ¸¬è©¦ **ç‰ˆæœ¬æ›´æ–°èˆ‡éƒ¨ç½²æ˜¯å¦æˆåŠŸ**ï¼Œä½ å¯ä»¥ç”¨é€™å€‹é é¢å…§å®¹ä¾†ç¢ºèªä½ éƒ¨ç½²çš„æ˜¯å“ªä¸€ç‰ˆã€‚

---

### `trigger-config.yaml`

é€™æ˜¯ Cloud Build è§¸ç™¼å™¨çš„è¨­å®šæª”ï¼Œè¨­å®šï¼š

* **ä¾†æºç‚º GitHub**ï¼Œå¸³è™Ÿæ˜¯ `haha1811`ã€Repo åç‚º `repo`
* ç•¶ `main` åˆ†æ”¯æœ‰ pushï¼Œå°±æœƒè‡ªå‹•è§¸ç™¼éƒ¨ç½²æµç¨‹ï¼ˆåŸ·è¡Œ `cloudbuild.yaml`ï¼‰

é€™ä»£è¡¨ä½ ç•¶åˆæ˜¯å¯¦ä½œã€Œ**CI/CD è‡ªå‹•éƒ¨ç½²æµç¨‹**ã€çš„ç·´ç¿’ã€‚

---

## âœ… çµè«–ï¼šé€™æ˜¯ Cloud Run è‡ªå‹•éƒ¨ç½²çš„ CI/CD å¯¦ä½œç·´ç¿’

ä½ é€™ä»½ç·´ç¿’æ˜¯å®Œæ•´å¯¦ä½œï¼š

* âœ… ä½¿ç”¨ GitHub â†’ Cloud Build Trigger â†’ Build â†’ Deploy Cloud Run
* âœ… å±•ç¤ºéœæ…‹ç¶²é ç‰ˆæœ¬ï¼ˆV03ï¼‰ä¾†é©—è­‰éƒ¨ç½²ç‰ˆæœ¬
* âœ… ä½¿ç”¨ Artifact Registry å„²å­˜ Docker æ˜ åƒ

---

éœ€è¦æˆ‘å¹«ä½ å¯«ä¸€ä»½é€™å€‹å¯¦ä½œçš„ `README.md` è¨˜éŒ„ï¼ˆå¯è¤‡è£½è²¼ä¸Šåˆ° HackMDï¼‰å—ï¼Ÿé‚„æ˜¯ä½ æƒ³å‡ç´šé€™ä»½ç·´ç¿’ï¼ŒåŠ å…¥åƒæ˜¯ç‰ˆæœ¬è™Ÿè‡ªå‹•ç”¢ç”Ÿã€è‡ªå‹•ä¿®æ”¹ `index.html`ã€æˆ– Cloud Run è‡ªè¨‚ç’°å¢ƒè®Šæ•¸ç­‰åŠŸèƒ½ï¼Ÿ




ç•¶ç„¶å¯ä»¥ï¼Œä»¥ä¸‹æ˜¯ä¸€ä»½æ¸…æ¥šã€çµæ§‹åŒ–ã€é©åˆè²¼ä¸Š HackMD çš„ `README.md`ï¼Œå¯ä½œç‚ºä½ é€™å€‹ Cloud Run è‡ªå‹•éƒ¨ç½²ç·´ç¿’çš„å®Œæ•´æŠ€è¡“ç´€éŒ„ï¼š

---

```markdown
# ğŸš€ GCP Cloud Run CI/CD è‡ªå‹•éƒ¨ç½²ç·´ç¿’ç´€éŒ„

æœ¬ç·´ç¿’ç¤ºç¯„å¦‚ä½•é€é GCP Cloud Build + GitHub Push è‡ªå‹•éƒ¨ç½² Docker æ˜ åƒè‡³ Cloud Runï¼Œä¸¦å‘ˆç¾ç‰ˆæœ¬è³‡è¨Šæ–¼éœæ…‹ç¶²é ä¸­ã€‚

---

## ğŸ“¦ å°ˆæ¡ˆçµæ§‹

```

.
â”œâ”€â”€ cloudbuild.yaml         # Cloud Build å»ºæ§‹èˆ‡éƒ¨ç½²æµç¨‹è¨­å®šæª”
â”œâ”€â”€ Dockerfile              # Docker æ˜ åƒå»ºæ§‹è¨­å®šï¼ˆApache + éœæ…‹ç¶²é ï¼‰
â”œâ”€â”€ index.html              # éƒ¨ç½²ç¶²é å…§å®¹ï¼Œå«ç‰ˆæœ¬è³‡è¨Š
â”œâ”€â”€ trigger-config.yaml     # Cloud Build è§¸ç™¼å™¨è¨­å®šæª”ï¼Œé€£æ¥ GitHub Push äº‹ä»¶
â””â”€â”€ README.md               # æœ¬èªªæ˜æª”

````

---

## ğŸ“Œ å¯¦ä½œç›®æ¨™

- âœ… ä½¿ç”¨ GitHub Push è§¸ç™¼ Cloud Build
- âœ… è‡ªå‹•å»ºæ§‹ Docker æ˜ åƒæª”
- âœ… æ¨é€æ˜ åƒè‡³ Artifact Registry
- âœ… è‡ªå‹•éƒ¨ç½²è‡³ Cloud Runï¼ˆå«å…¬é–‹è¨ªå•è¨­å®šï¼‰
- âœ… ç¶²é é¡¯ç¤ºç•¶å‰éƒ¨ç½²ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ï¼š`V03`ï¼‰

---

## ğŸ”§ æ“ä½œæ­¥é©Ÿèªªæ˜

### 1ï¸âƒ£ å»ºç«‹ GitHub Repo ä¸¦ä¸Šå‚³ä»¥ä¸‹æª”æ¡ˆ
- `cloudbuild.yaml`
- `Dockerfile`
- `index.html`
- `trigger-config.yaml`ï¼ˆåƒ…ä¾›å»ºç«‹ Cloud Build è§¸ç™¼å™¨æ™‚åƒè€ƒï¼‰

### 2ï¸âƒ£ å»ºç«‹ Cloud Build è§¸ç™¼å™¨

å‰å¾€ GCP Console â†’ **Cloud Build > Triggers**ï¼Œé¸æ“‡ï¼š
- **ä¾†æºå€‰å„²**ï¼šGitHubï¼ˆä½¿ç”¨ `haha1811/repo`ï¼‰
- **æ¢ä»¶**ï¼šç•¶ `main` åˆ†æ”¯æœ‰ Push æ™‚è§¸ç™¼
- **å»ºæ§‹æª”æ¡ˆ**ï¼šä½¿ç”¨ `cloudbuild.yaml`

---

## ğŸ” å„æª”æ¡ˆå…§å®¹é‡é»

### âœ… `cloudbuild.yaml`

```yaml
steps:
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'asia-east1-docker.pkg.dev/lab-dev-421508/my-repo/ap:v03', '.']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'asia-east1-docker.pkg.dev/lab-dev-421508/my-repo/ap:v03']
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args: [
      'run', 'deploy', 'my-repo',
      '--image', 'asia-east1-docker.pkg.dev/lab-dev-421508/my-repo/ap:v03',
      '--region', 'asia-east1',
      '--allow-unauthenticated',
      '--port', '80'
    ]

images:
  - 'asia-east1-docker.pkg.dev/lab-dev-421508/my-repo/ap:v03'
````

### âœ… `Dockerfile`

```dockerfile
FROM ubuntu:20.04
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y apache2
COPY index.html /var/www/html/index.html
EXPOSE 80
CMD ["/usr/sbin/apache2ctl", "-D", "FOREGROUND"]
```

### âœ… `index.html`

```html
AP
V03
```

æ­¤æª”æ¡ˆç‚ºå±•ç¤ºå…§å®¹ï¼Œéƒ¨ç½²å¾Œé–‹å•Ÿç¶²å€å³å¯çœ‹åˆ°ã€ŒAPã€èˆ‡ç‰ˆæœ¬è™Ÿ `V03`ï¼Œå¯ä½œç‚ºç‰ˆæœ¬é©—è­‰ç”¨é€”ã€‚

---

## ğŸŒ Cloud Run è¨­å®š

* éƒ¨ç½²æœå‹™åç¨±ï¼š`my-repo`
* æ˜ åƒè·¯å¾‘ï¼š`asia-east1-docker.pkg.dev/lab-dev-421508/my-repo/ap:v03`
* å€åŸŸï¼š`asia-east1`
* æ¬Šé™ï¼š`--allow-unauthenticated`ï¼ˆå…¬é–‹å¯è¨ªå•ï¼‰

---

## âœ… æˆåŠŸéƒ¨ç½²å¾Œ

ä½ å¯ä»¥é€é Cloud Run æœå‹™ç¶²å€æ‰“é–‹å¾Œï¼Œçœ‹åˆ°å¦‚ä¸‹ç•«é¢ä»£è¡¨æˆåŠŸï¼š

```
AP
V03
```

å¦‚éœ€å‡ç´šç‰ˆæœ¬ï¼Œåªè¦æ›´æ–° `index.html`ã€ä¿®æ”¹ `v03` ç‚ºæ–°ç‰ˆæœ¬ï¼Œå† Push ä¸€æ¬¡å³å¯è‡ªå‹•é‡å»ºéƒ¨ç½²ã€‚

---

## ğŸ§  å»¶ä¼¸å»ºè­°

| é …ç›®          | èªªæ˜                                   |
| ----------- | ------------------------------------ |
| ğŸ” è‡ªå‹•ç‰ˆæœ¬ç·¨è™Ÿ   | å¯ä½¿ç”¨ `SHORT_SHA` æˆ–æ™‚é–“æˆ³è¨˜è‡ªå‹•æ›¿æ›ç‰ˆæœ¬è™Ÿ         |
| ğŸ§ª åŠ å…¥å¥åº·æª¢æŸ¥   | å¯åœ¨éƒ¨ç½²å¾ŒåŠ å…¥ Cloud Run å¥åº·æª¢æŸ¥æ©Ÿåˆ¶             |
| ğŸŒ ç¶²åŸŸç¶å®š     | å¯ç¶å®šè‡ªæœ‰ç¶²åŸŸï¼Œæ­é… HTTPS                     |
| ğŸ” IAM æœ€å°æ¬Šé™ | å»ºè­°ç‚º Cloud Build èˆ‡ Cloud Run æŒ‡å®šæœ€å°å¿…è¦æ¬Šé™ |
| ğŸ“„ è‡ªå‹•ç”¢å‡ºç‰ˆæœ¬é é¢ | ä½¿ç”¨ `sed` è‡ªå‹•å¯«å…¥ `index.html` ç‰ˆæœ¬è³‡è¨Š      |

---

## ğŸ™‹â€â™‚ï¸ ä½œè€…è¨»è¨˜

æ­¤å°ˆæ¡ˆä½œç‚º GCP Cloud Run å¯¦æˆ°ç·´ç¿’ï¼Œè®“ä½ ç†Ÿæ‚‰ï¼š

* Docker å»ºæ§‹æµç¨‹
* Artifact Registry æ¨é€æ“ä½œ
* Cloud Build è‡ªå‹•éƒ¨ç½²æµç¨‹
* Cloud Run ç„¡ä¼ºæœå™¨æ¶æ§‹éƒ¨ç½²å¯¦ä½œ

```

---

éœ€è¦æˆ‘å¹«ä½ è£œä¸€å¼µ Cloud Run æ¶æ§‹åœ–ï¼ˆğŸ“¦ Docker â†’ ğŸ”§ Cloud Build â†’ â˜ï¸ Cloud Runï¼‰ä¾†æ­é…é€™ä»½èªªæ˜å—ï¼Ÿ
```



[![GCP Cloud Build è·¨å°ˆæ¡ˆéƒ¨ç½² | Use Cloud Build to deploy service to different ...](https://tse1.mm.bing.net/th?id=OIP.GUiS7Ij274UutiYeICMXdAHaFq\&cb=iwp1\&pid=Api)](https://andy51002000.blogspot.com/2020/05/gcp-cloud-build-use-cloud-build-to.html)

ç•¶ç„¶å¯ä»¥ï¼Œä»¥ä¸‹æ˜¯ä¸€å¼µç°¡æ½”çš„ GCP Cloud Run è‡ªå‹•éƒ¨ç½²æ¶æ§‹åœ–ï¼Œå±•ç¤ºäº†å¾åŸå§‹ç¢¼æäº¤åˆ°æœå‹™éƒ¨ç½²çš„æ•´å€‹æµç¨‹ï¼š

---

### ğŸ–¼ï¸ Cloud Run è‡ªå‹•éƒ¨ç½²æ¶æ§‹åœ–

```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHub    â”‚
â”‚  (main åˆ†æ”¯)â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚ Push
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloud Build  â”‚
â”‚ (Trigger)    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥é©Ÿ 1: å»ºæ§‹ Docker æ˜ åƒæª”    â”‚
â”‚ æ­¥é©Ÿ 2: æ¨é€è‡³ Artifact Registry â”‚
â”‚ æ­¥é©Ÿ 3: éƒ¨ç½²è‡³ Cloud Run        â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloud Run æœå‹™               â”‚
â”‚ (å…¬é–‹ç¶²å€ï¼Œæä¾› Web æœå‹™)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ğŸ”§ æµç¨‹èªªæ˜

1. **GitHub Push**ï¼šç•¶ä½ å°‡ç¨‹å¼ç¢¼æ¨é€åˆ° GitHub çš„ `main` åˆ†æ”¯æ™‚ï¼Œæœƒè§¸ç™¼ Cloud Buildã€‚

2. **Cloud Build**ï¼šæ ¹æ“š `cloudbuild.yaml` çš„è¨­å®šï¼ŒåŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿï¼š

   * **å»ºæ§‹æ˜ åƒæª”**ï¼šä½¿ç”¨ Dockerfile å»ºæ§‹æ˜ åƒæª”ã€‚
   * **æ¨é€æ˜ åƒæª”**ï¼šå°‡å»ºæ§‹å¥½çš„æ˜ åƒæª”æ¨é€åˆ° Artifact Registryã€‚
   * **éƒ¨ç½²è‡³ Cloud Run**ï¼šä½¿ç”¨ `gcloud run deploy` å°‡æ˜ åƒæª”éƒ¨ç½²åˆ° Cloud Runã€‚

3. **Cloud Run æœå‹™**ï¼šéƒ¨ç½²å®Œæˆå¾Œï¼ŒCloud Run æœƒæä¾›ä¸€å€‹å…¬é–‹çš„ç¶²å€ï¼Œä¾›ä½¿ç”¨è€…è¨ªå•ä½ çš„ Web æœå‹™ã€‚

---

é€™å¼µæ¶æ§‹åœ–æ¸…æ¥šåœ°å±•ç¤ºäº†å¾ç¨‹å¼ç¢¼æäº¤åˆ°æœå‹™éƒ¨ç½²çš„è‡ªå‹•åŒ–æµç¨‹ï¼Œé©åˆç”¨æ–¼æŠ€è¡“æ–‡ä»¶ã€ç°¡å ±æˆ–åœ˜éšŠåˆ†äº«ã€‚å¦‚æœä½ éœ€è¦æ›´è©³ç´°çš„åœ–ç¤ºæˆ–æœ‰å…¶ä»–éœ€æ±‚ï¼Œæ­¡è¿éš¨æ™‚å‘Šè¨´æˆ‘ï¼


